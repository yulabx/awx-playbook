---
- name: ğŸš€ Kubernetes Project Setup (AWX Optimized with Auto-Calculation)
  hosts: localhost
  connection: local
  gather_facts: false

  collections:
    - kubernetes.core

  vars:
    # ------------------------------------
    # ç°¡åŒ– ResourceQuota è¼¸å…¥ (ç”¨æˆ¶åªéœ€å¡« Limits)
    # é€™äº›è®Šæ•¸æ‡‰ç”± AWX Job Template çš„ Extra Variables æä¾›
    # ------------------------------------
    ns_name: "demo"              # å‘½åç©ºé–“åç¨±
    total_cpu_limit: "10"        # ç¸½ CPU ç¡¬ä¸Šé™ (ä¾‹å¦‚ "10")
    total_memory_limit: "20Gi"   # ç¸½ Memory ç¡¬ä¸Šé™ (ä¾‹å¦‚ "20Gi")
    total_storage_limit: "1TB"   # ç¸½ Storage ç¸½é‡ä¸Šé™ (ä¾‹å¦‚ "1TB")

    # ------------------------------------
    # å…§éƒ¨è¨ˆç®—é‚è¼¯ (Requests = 80% Limits)
    # ------------------------------------
    request_ratio: 0.8           # Requests æ¯”ä¾‹ï¼šé è¨­ 80%
    resource_quota_name: "{{ ns_name }}-quota"
    create_resource_quota: true

    # è¨ˆç®— CPU Requests: (ç¸½é™åˆ¶ * 0.8) å››æ¨äº”å…¥å–æ•´
    # ä¾‹: 10 * 0.8 = 8
    calculated_cpu_request: "{{ (total_cpu_limit | int * request_ratio) | round | string }}"
    
    # è¨ˆç®— Memory Requests: (å»æ‰å–®ä½ Gi/Mi å¾Œè¨ˆç®— * 0.8) å–æ•´å¾ŒåŠ ä¸Šå–®ä½
    # ä¾‹: 20Gi * 0.8 = 16Gi
    calculated_memory_request: "{{ (total_memory_limit | regex_replace('Gi', '') | float * request_ratio) | int | string + 'Gi' }}"

    # çµ„åˆ ResourceQuota Hard åƒæ•¸ (å°‡è¨ˆç®—çµæœæ”¾å…¥æœ€çµ‚çš„ K8s ç‰©ä»¶å®šç¾©)
    resource_quota_hard:
      limits.cpu: "{{ total_cpu_limit }}"
      requests.cpu: "{{ calculated_cpu_request }}"
      limits.memory: "{{ total_memory_limit }}"
      requests.memory: "{{ calculated_memory_request }}"
      requests.storage: "{{ total_storage_limit }}"
      persistentvolumeclaims: 50 # é è¨­ PVC æ•¸é‡ä¸Šé™
      
    # ------------------------------------
    # PVC Configuration
    # ------------------------------------
    create_default_pvc: false
    default_pvc_size: "50Gi"
    default_storage_class: "microk8s-hostpath" 
    default_pvc_name: "{{ ns_name }}-default-pvc" # PVC åç¨±è‡ªå‹•å‘½å

    # ------------------------------------
    # å…¶ä»–å¯é¸è¨­å®š
    # ------------------------------------
    create_limit_range: false
    create_default_deny_network_policy: false
    labels: {}
    annotations: {}

  tasks:
    - name: 0. Show calculated Resource Quota values
      ansible.builtin.debug:
        msg: |
          Project Setup for Namespace: {{ ns_name }}
          - CPU Limits: {{ total_cpu_limit }} / Requests: {{ calculated_cpu_request }}
          - Memory Limits: {{ total_memory_limit }} / Requests: {{ calculated_memory_request }}
          - PVC Name: {{ default_pvc_name }} ({{ default_pvc_size }})

    # =========================
    # 1. Create/Ensure Namespace
    # =========================
    - name: 1. Create/Ensure Namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ ns_name }}"
            labels: "{{ labels | default({}) }}"
            annotations: "{{ annotations | default({}) }}"
      register: ns_result

    # =========================
    # 2. Create/Update ResourceQuota (ä½¿ç”¨è¨ˆç®—å¾Œçš„ resource_quota_hard)
    # =========================
    - name: 2. Create/Update ResourceQuota
      when: create_resource_quota | bool
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: "{{ resource_quota_name }}"
            namespace: "{{ ns_name }}"
          spec:
            hard: "{{ resource_quota_hard }}"

    # =========================
    # 3. Optional: LimitRange
    # =========================
    - name: 3. Create/Update LimitRange
      when: create_limit_range | bool
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: LimitRange
          metadata:
            name: "{{ limit_range_name }}"
            namespace: "{{ ns_name }}"
          spec:
            limits:
              - type: Container
                default: "{{ limit_range_container_defaults.default }}"
                defaultRequest: "{{ limit_range_container_defaults.defaultRequest }}"
                max: "{{ limit_range_container_defaults.max }}"
                min: "{{ limit_range_container_defaults.min }}"
                
    # =========================
    # 4. Create PersistentVolumeClaim (ä½¿ç”¨è‡ªå‹•å‘½å)
    # =========================
    - name: 4. Create default PVC for the namespace
      when: create_default_pvc | bool
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: "{{ ns_name }}-default-pvc"
            namespace: "{{ ns_name }}"
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: "{{ default_pvc_size }}"
            storageClassName: "{{ default_storage_class if default_storage_class | length > 0 else omit }}"
      register: pvc_result

    # =========================
    # 5. Optional: Default Deny NetworkPolicy
    # =========================
    - name: 5. Create default deny all ingress/egress NetworkPolicy
      when: create_default_deny_network_policy | bool
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: "{{ default_deny_network_policy_name }}"
            namespace: "{{ ns_name }}"
          spec:
            podSelector: {}
            policyTypes: [Ingress, Egress]

    # ---- å›å‚³æœ€çµ‚çµæœ ----
    - name: Print Final Result Summary
      ansible.builtin.debug:
        msg: |
          âœ… Project Setup Completed for Namespace: {{ ns_name }}
          - ResourceQuota Applied (Limits/Requests): {{ total_cpu_limit }}/{{ calculated_cpu_request }}
          - Default PVC Created: {{ default_pvc_name }} ({{ default_pvc_size }})
