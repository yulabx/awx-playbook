---
- name: Create Kubernetes Namespace (Base64 input - auto decode)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - kubernetes.core

  vars:
    host: ""
    verify_ssl: true
    ns_name: "demo"
    labels: {}
    annotations: {}
    ca_data: ""
    client_certificate_data: ""
    client_key_data: ""

  tasks:
    - name: Check required inputs
      ansible.builtin.assert:
        that:
          - host | length > 0
          - ns_name | length > 0
          - ca_data | length > 0
          - client_certificate_data | length > 0
          - client_key_data | length > 0
        fail_msg: "必要參數未提供（host, ns_name, ca_data, client_certificate_data, client_key_data）"

    - name: Create temp files
      ansible.builtin.tempfile:
        state: file
        suffix: "{{ item }}"
      loop:
        - "-ca.crt"
        - "-client.crt"
        - "-client.key"
      register: tmp_files

    - name: Set cert paths
      ansible.builtin.set_fact:
        ca_file: "{{ tmp_files.results[0].path }}"
        cert_file: "{{ tmp_files.results[1].path }}"
        key_file: "{{ tmp_files.results[2].path }}"

    # 自動偵測 decode 1 次或 2 次
    - name: Write CA cert (auto decode)
      ansible.builtin.copy:
        dest: "{{ ca_file }}"
        content: >-
          {% set decoded = ca_data | regex_replace('\\s+', '') | b64decode %}
          {% if '-----BEGIN' in decoded %}
          {{ decoded }}
          {% else %}
          {{ decoded | b64decode }}
          {% endif %}
        mode: '0600'

    - name: Write client cert (auto decode)
      ansible.builtin.copy:
        dest: "{{ cert_file }}"
        content: >-
          {% set decoded = client_certificate_data | regex_replace('\\s+', '') | b64decode %}
          {% if '-----BEGIN' in decoded %}
          {{ decoded }}
          {% else %}
          {{ decoded | b64decode }}
          {% endif %}
        mode: '0600'

    - name: Write client key (auto decode)
      ansible.builtin.copy:
        dest: "{{ key_file }}"
        content: >-
          {% set decoded = client_key_data | regex_replace('\\s+', '') | b64decode %}
          {% if '-----BEGIN' in decoded %}
          {{ decoded }}
          {% else %}
          {{ decoded | b64decode }}
          {% endif %}
        mode: '0600'

    - name: Verify decoded PEM headers
      ansible.builtin.shell: "head -n 1 {{ item }}"
      loop:
        - "{{ ca_file }}"
        - "{{ cert_file }}"
        - "{{ key_file }}"
      register: pem_headers
      changed_when: false

    - name: Show decoded PEM header lines
      ansible.builtin.debug:
        msg: "{{ pem_headers.results | map(attribute='stdout') | list }}"

    - name: Ensure namespace exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ ns_name }}"
            labels: "{{ labels }}"
            annotations: "{{ annotations }}"
        host: "{{ host }}"
        ssl_ca_cert: "{{ ca_file }}"
        cert_file: "{{ cert_file }}"
        key_file: "{{ key_file }}"
        validate_certs: "{{ verify_ssl }}"
      register: ns_result

    - name: Report result
      ansible.builtin.debug:
        msg: "Namespace '{{ ns_name }}' ensured. changed={{ ns_result.changed }}"

    - name: Clean temp files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ ca_file }}"
        - "{{ cert_file }}"
        - "{{ key_file }}"
