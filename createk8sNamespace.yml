---
- name: ğŸš€ Kubernetes Project Setup (Static Requests = Limits)
  hosts: localhost
  connection: local
  gather_facts: false

  collections:
    - kubernetes.core

  # =======================================================
  # I. è®Šæ•¸å€å¡Šï¼šåªä¿ç•™è¼¸å…¥å’Œéœæ…‹é…ç½®
  # =======================================================
  vars:
    # --- æ ¸å¿ƒè¼¸å…¥ (å¤–éƒ¨ JSON æä¾›ï¼Œå·²ä¿®æ”¹ç‚º namespace) ---
    namespace: "demo" # æ›¿æ›è‡ª ns_name
    namespace_cpu_limit: "8"  
    namespace_memory_limit: "8Gi" 
    namespace_storage_limit: "500Gi" 
    
    # --- éœæ…‹é…ç½®/é è¨­å€¼ ---
    create_resource_quota: true
    create_default_pvc: true
    default_pvc_size: "50Gi"
    default_storage_class: "microk8s-hostpath" 
    create_limit_range: false
    create_default_deny_network_policy: false
    namespace_labels: {} 
    annotations: {}


  # =======================================================
  # II. ä¸»è¦ä»»å‹™å€å¡Š (Requests = Limits)
  # =======================================================
  tasks:
    # 0.0 ä»»å‹™ï¼šå°‡ Requests è¨­ç‚º Limits çš„å€¼ (æ’é™¤æ‰€æœ‰è¨ˆç®—é‚è¼¯)
    - name: 0.0 Set Requests = Limits Variables
      ansible.builtin.set_fact:
        # Requests ç›´æ¥ç­‰æ–¼ Limits çš„è¼¸å…¥å€¼
        calculated_cpu_request: "{{ namespace_cpu_limit }}"
        calculated_memory_request: "{{ namespace_memory_limit }}"
        
        # çµ„åˆ ResourceQuota Hard åƒæ•¸
        resource_quota_hard:
          limits.cpu: "{{ namespace_cpu_limit }}"
          requests.cpu: "{{ namespace_cpu_limit }}"  # Requests = Limits
          limits.memory: "{{ namespace_memory_limit }}"
          requests.memory: "{{ namespace_memory_limit }}" # Requests = Limits
          requests.storage: "{{ namespace_storage_limit }}"
          persistentvolumeclaims: 50
          
        # çµ„åˆ K8s ç‰©ä»¶åç¨± (ä½¿ç”¨æ–°çš„ namespace è®Šæ•¸)
        default_pvc_name: "{{ namespace }}-default-pvc"
        resource_quota_name: "{{ namespace }}-quota"
        limit_range_name: "{{ namespace }}-limits"
        
    - name: 0.1 Show final configuration (Requests = Limits)
      ansible.builtin.debug:
        msg: |
          Project Namespace: {{ namespace }}
          - CPU Limits/Requests: {{ namespace_cpu_limit }}/{{ calculated_cpu_request }} (Requests = Limits)
          - Memory Limits/Requests: {{ namespace_memory_limit }}/{{ calculated_memory_request }} (Requests = Limits)
          - Storage Limit: {{ namespace_storage_limit }}
          
    # 1. Create/Ensure Namespace
    - name: 1. Create/Ensure Namespace
      kubernetes.core.k8s:
        # ç¹é SSL é©—è­‰
        validate_certs: no 
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespace }}"
            labels: "{{ namespace_labels | default({}) }}" 
            annotations: "{{ annotations | default({}) }}"

    # 2. Create/Update ResourceQuota
    - name: 2. Create/Update ResourceQuota
      when: create_resource_quota | bool
      kubernetes.core.k8s:
        # ç¹é SSL é©—è­‰
        validate_certs: no 
        state: present
        definition:
          apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: "{{ resource_quota_name }}"
            namespace: "{{ namespace }}"
          spec:
            hard: "{{ resource_quota_hard }}"

    # 3. Create/Update LimitRange
    - name: 3. Create/Update LimitRange
      when: create_limit_range | bool
      kubernetes.core.k8s:
        # ç¹é SSL é©—è­‰
        validate_certs: no 
        state: present
        definition:
          apiVersion: v1
          kind: LimitRange
          metadata:
            name: "{{ limit_range_name }}"
            namespace: "{{ namespace }}"
          spec:
            limits:
              - type: Container
                default: {cpu: "500m", memory: "512Mi"}
                defaultRequest: {cpu: "100m", memory: "128Mi"}
                max: {cpu: "2", memory: "2Gi"}
                min: {cpu: "50m", memory: "64Mi"}

    # 4. Create PersistentVolumeClaim
    - name: 4. Create default PVC ({{ default_pvc_name }})
      when: create_default_pvc | bool
      kubernetes.core.k8s:
        # ç¹é SSL é©—è­‰
        validate_certs: no 
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: "{{ default_pvc_name }}"
            namespace: "{{ namespace }}"
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: "{{ default_pvc_size }}"
            storageClassName: "{{ default_storage_class if default_storage_class | length > 0 else omit }}"

    # 5. Create Default Deny NetworkPolicy
    - name: 5. Create default deny all ingress/egress NetworkPolicy
      when: create_default_deny_network_policy | bool
      kubernetes.core.k8s:
        # ç¹é SSL é©—è­‰
        validate_certs: no 
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: "{{ namespace }}-default-deny"
            namespace: "{{ namespace }}"
          spec:
            podSelector: {}
            policyTypes: [Ingress, Egress]

    # ---- æœ€çµ‚ç¸½çµ ----
    - name: Print Final Result Summary
      ansible.builtin.debug:
        msg: "âœ… Namespace '{{ namespace }}' setup complete (Requests = Limits)."
