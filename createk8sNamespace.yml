---
- name: üöÄ Kubernetes Project Setup (AWX Final & Corrected Version)
  hosts: localhost
  connection: local
  gather_facts: false

  collections:
    - kubernetes.core

  vars:
    # ------------------------------------
    # I. Áî®Êà∂Ëº∏ÂÖ•ËÆäÊï∏ (ÊáâÁî± AWX Extra Variables Êèê‰æõ)
    # ------------------------------------
    ns_name: "demo"
    total_cpu_limit: "10"
    total_memory_limit: "20Gi"
    total_storage_limit: "1TB"
    
    # PVC Â∞àÂ±¨Ë®≠ÂÆö
    create_default_pvc: true
    default_pvc_size: "50Gi"
    default_storage_class: "microk8s-hostpath" 

    # ------------------------------------
    # II. ÈùúÊÖãÈÖçÁΩÆ/È†êË®≠ÂÄº
    # ------------------------------------
    request_ratio: 0.8          # Requests ÊØî‰æãÔºöÈ†êË®≠ 80%
    create_resource_quota: true
    create_limit_range: false
    create_default_deny_network_policy: false
    
    # Metadata (ÂèØÁî±Â§ñÈÉ® JSON Ë¶ÜÂØ´)
    labels: {}
    annotations: {}


  # Á¢∫‰øù pre_tasks ÂçÄÂ°äËàá vars ÂçÄÂ°äÂ±§Á¥öÁõ∏Âêå (È†ÇÂ±§ÔºåÊ≤íÊúâÁ∏ÆÊéí)
  pre_tasks:
    # Á¢∫‰øù‰ªªÂãôÂêçÁ®± (name) Á∏ÆÊéíÂÖ©ÂÄãÁ©∫Ê†º
    - name: Pre_1. Calculate Resource Quota Requests and Define Final Objects
      # Á¢∫‰øù set_fact Á∏ÆÊéíÂõõÂÄãÁ©∫Ê†º
      ansible.builtin.set_fact:
        # 1. Ë®àÁÆó CPU Requests (Â∑≤‰øÆÊ≠£ÔºåÁ¢∫‰øùÊòØÊï¥Êï∏)
        calculated_cpu_request: "{{ ((total_cpu_limit | int * request_ratio) | round | int) | string }}"
        
        # 2. Ë®àÁÆó Memory Requests
        calculated_memory_request: "{{ (total_memory_limit | regex_replace('Gi', '') | float * request_ratio) | int | string + 'Gi' }}"
        
        # 3. ÁµÑÂêà ResourceQuota Hard ÂèÉÊï∏
        resource_quota_hard:
          limits.cpu: "{{ total_cpu_limit }}"
          requests.cpu: "{{ calculated_cpu_request }}"
          limits.memory: "{{ total_memory_limit }}"
          requests.memory: "{{ calculated_memory_request }}"
          requests.storage: "{{ total_storage_limit }}"
          persistentvolumeclaims: 50
          
        # 4. ÁµÑÂêà K8s Áâ©‰ª∂ÂêçÁ®±
        default_pvc_name: "{{ ns_name }}-default-pvc"
        resource_quota_name: "{{ ns_name }}-quota"
        limit_range_name: "{{ ns_name }}-limits"


  # Á¢∫‰øù tasks ÂçÄÂ°äËàá vars ÂçÄÂ°äÂ±§Á¥öÁõ∏Âêå (È†ÇÂ±§ÔºåÊ≤íÊúâÁ∏ÆÊéí)
  tasks:
    - name: 0. Show final calculated configuration
      ansible.builtin.debug:
        msg: |
          Project Namespace: {{ ns_name }}
          - CPU Limits/Requests: {{ total_cpu_limit }}/{{ calculated_cpu_request }}
          - Memory Limits/Requests: {{ total_memory_limit }}/{{ calculated_memory_request }}
          - Storage Limit: {{ total_storage_limit }}
          - PVC Name & Size: {{ default_pvc_name }} ({{ default_pvc_size }})

    # =========================
    # 1. Create/Ensure Namespace
    # =========================
    - name: 1. Create/Ensure Namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ ns_name }}"
            labels: "{{ labels | default({}) }}"
            annotations: "{{ annotations | default({}) }}"

    # =========================
    # 2. Create/Update ResourceQuota
    # =========================
    - name: 2. Create/Update ResourceQuota
      when: create_resource_quota | bool
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: "{{ resource_quota_name }}"
            namespace: "{{ ns_name }}"
          spec:
            hard: "{{ resource_quota_hard }}"

    # =========================
    # 3. Create/Update LimitRange
    # =========================
    - name: 3. Create/Update LimitRange
      when: create_limit_range | bool
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: LimitRange
          metadata:
            name: "{{ limit_range_name }}"
            namespace: "{{ ns_name }}"
          spec:
            limits:
              - type: Container
                default: {cpu: "500m", memory: "512Mi"}
                defaultRequest: {cpu: "100m", memory: "128Mi"}
                max: {cpu: "2", memory: "2Gi"}
                min: {cpu: "50m", memory: "64Mi"}

    # =========================
    # 4. Create PersistentVolumeClaim
    # =========================
    - name: 4. Create default PVC ({{ default_pvc_name }})
      when: create_default_pvc | bool
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: "{{ default_pvc_name }}"
            namespace: "{{ ns_name }}"
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: "{{ default_pvc_size }}"
            storageClassName: "{{ default_storage_class if default_storage_class | length > 0 else omit }}"

    # =========================
    # 5. Create Default Deny NetworkPolicy
    # =========================
    - name: 5. Create default deny all ingress/egress NetworkPolicy
      when: create_default_deny_network_policy | bool
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: "{{ ns_name }}-default-deny"
            namespace: "{{ ns_name }}"
          spec:
            podSelector: {}
            policyTypes: [Ingress, Egress]

    # ---- ÊúÄÁµÇÁ∏ΩÁµê ----
    - name: Print Final Result Summary
      ansible.builtin.debug:
        msg: "‚úÖ Namespace '{{ ns_name }}' setup complete. Quota Requests: CPU {{ calculated_cpu_request }}, Memory {{ calculated_memory_request }}."
