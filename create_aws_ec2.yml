---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Step 2: åœ¨æŒ‡å®šçš„ Subnet å»ºç«‹ EC2 å¯¦ä¾‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä½¿ç”¨å ´æ™¯: Step 1 å»ºç«‹å®ŒåŸºç¤è¨­æ–½å¾Œï¼Œä½¿ç”¨æ­¤è…³æœ¬å»ºç«‹ EC2
# 
# å‰ç½®æ¢ä»¶:
#   1. Step 1 å·²åŸ·è¡Œå®Œæˆ
#   2. å·²æœ‰ {project_name}_infrastructure.yml æª”æ¡ˆ
#   3. å·²çŸ¥è¦éƒ¨ç½²åœ¨å“ªå€‹ Subnet
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: Step 2 - Create EC2 Instances in Specified Subnet
  hosts: localhost
  gather_facts: true
  
  vars:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # å¾å‰ç«¯/AWX å‚³å…¥çš„åƒæ•¸ (èˆ‡ Step 1 ç›¸åŒ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # cluster_region: "ap-northeast-1"       # AWS Region (é¸å¡«ï¼Œé è¨­ ap-northeast-1)
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # é è¨­å€¼
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    default_cluster_region: ap-northeast-1
    cluster_region: "{{ cluster_region | default(default_cluster_region) }}"
    
    # å°ˆæ¡ˆ Key Pair å‘½åè¦å‰‡ (è‡ªå‹•ä½¿ç”¨å°ˆæ¡ˆå°ˆç”¨é‡‘é‘°)
    default_key_name: "{{ project_name }}-keypair"

    # EC2 IAM Instance Profile åç¨± (å¯ä¾éœ€æ±‚èª¿æ•´)
    iam_instance_profile_name: EC2-CloudWatchAgent-Role

    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # å…¶ä»–å¾å‰ç«¯/AWX å‚³å…¥çš„åƒæ•¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # project_name: "ita"                    # å°ˆæ¡ˆåç¨± (èˆ‡ Step 1 ç›¸åŒ)
    # project_labels:                        # å°ˆæ¡ˆæ¨™ç±¤
    #   env: "dev"
    #   project.id: "ita"
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # EC2 éƒ¨ç½²åƒæ•¸ (å¾å‰ç«¯/AWX å‚³å…¥)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ec2_instances:
    #   - name: bastion-01
    #     subnet_name: "ita-bastion-subnet"   # Subnet åç¨± (å®Œæ•´åç¨±,ç”± UI ä¸²å¥½)
    #     instance_type: t3.micro
    #     ami_id: ami-0d52744d6551d851e
    #     key_name: ProjectX-keypair          # (é¸å¡«) è‹¥ä¸å¡«ï¼Œè‡ªå‹•ä½¿ç”¨ {project_name}-keypair
    #     private_ip: 10.100.1.10
    #     assign_public_ip: true
    #     volume_size: 20
    #     tags:
    #       Role: Bastion
    #       Environment: Production

  tasks:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 1: æ ¹æ“šå‘½åè¦å‰‡æŸ¥è©¢ VPC ID
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Get VPC by name
      amazon.aws.ec2_vpc_net_info:
        region: "{{ cluster_region }}"
        filters:
          "tag:Name": "{{ project_name }}"
      register: vpc_info
    
    - name: Validate VPC exists
      fail:
        msg: "æ‰¾ä¸åˆ° VPC: {{ project_name }}ï¼Œè«‹å…ˆåŸ·è¡Œ Step 1"
      when: vpc_info.vpcs | length == 0
    
    - name: Set VPC ID
      set_fact:
        vpc_id: "{{ vpc_info.vpcs[0].id }}"
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 2: æ ¹æ“šå‘½åè¦å‰‡æŸ¥è©¢æ‰€æœ‰ Subnet ID
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Get all subnets for this project
      amazon.aws.ec2_vpc_subnet_info:
        region: "{{ cluster_region }}"
        filters:
          vpc-id: "{{ vpc_id }}"
          "tag:Project": "{{ project_name }}"
      register: subnets_info
    
    - name: Create subnet name to ID mapping
      set_fact:
        subnet_map: "{{ subnet_map | default({}) | combine({item.tags.Name: item.id}) }}"
      loop: "{{ subnets_info.subnets }}"
      vars:
        # å¾å®Œæ•´åç¨±æå– subnet name (ProjectX-prod-bastion-subnet â†’ bastion)
        subnet_name: "{{ item.tags.Name | regex_replace(project_name + '-(.+)-subnet', '\\1') }}"
      loop_control:
        loop_var: item
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 3: æ ¹æ“šå‘½åè¦å‰‡æŸ¥è©¢æ‰€æœ‰ Security Group ID
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Get all security groups for this project
      amazon.aws.ec2_security_group_info:
        region: "{{ cluster_region }}"
        filters:
          vpc-id: "{{ vpc_id }}"
          "tag:Project": "{{ project_name }}"
      register: sg_info
    
    - name: Create security group name to ID mapping
      set_fact:
        sg_map: "{{ sg_map | default({}) | combine({item.tags.Name: item.group_id}) }}"
      loop: "{{ sg_info.security_groups }}"
      when: item.tags.Name is defined
    
    - name: Display resource mappings
      debug:
        msg:
          - "VPC ID: {{ vpc_id }}"
          - "Subnet å°æ‡‰:"
          - "{{ subnet_map }}"
          - "Security Group å°æ‡‰:"
          - "{{ sg_map | default({}) }}"
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 4: å»ºç«‹ EC2 å¯¦ä¾‹
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create EC2 instances
      amazon.aws.ec2_instance:
        region: "{{ cluster_region }}"
        name: "{{ project_name }}-{{ item.name }}"
        instance_type: "{{ item.instance_type }}"
        image_id: "{{ item.ami_id }}"
        key_name: "{{ item.key_name | default(default_key_name) }}"  # è‡ªå‹•ä½¿ç”¨å°ˆæ¡ˆ Key
        
        # ç›´æ¥ç”¨ subnet_name å¾ subnet_map æŸ¥æ‰¾ ID
        vpc_subnet_id: "{{ subnet_map[item.subnet_name] }}"
        
        # ç”¨ subnet_name ç½®æ›å¾Œç¶€çµ„ sg_map æŸ¥æ‰¾ SG ID
        security_groups:
          - "{{ sg_map[item.subnet_name | regex_replace('-subnet$', '-sg')] }}"
        
        # ç¶²è·¯è¨­å®š (ä½¿ç”¨æ–°çš„ network_interfaces åƒæ•¸)
        network_interfaces:
          - assign_public_ip: "{{ item.assign_public_ip }}"
            private_ip_address: "{{ item.private_ip }}"
            device_index: 0
            delete_on_termination: true

        # æ›ä¸Š CloudWatch Agent IAM Role
        iam_instance_profile: "{{ iam_instance_profile_name }}"
        user_data: "{{ lookup('template', 'templates/cloudwatch_agent_userdata.sh.j2') }}"
        
        # å„²å­˜è¨­å®š
        root_volume:
          volume_size: "{{ item.volume_size }}"
          volume_type: gp3
          delete_on_termination: true
        
        # æ¨™ç±¤
        tags: "{{ {'Name': project_name + '-' + item.name, 'Project': project_name, 'SubnetName': item.subnet_name, 'Env': project_labels.env, 'ProjectId': project_labels['project.id'], 'ManagedBy': 'Ansible', 'CreatedDate': ansible_date_time.date} | combine(item.tags | default({})) }}"
        
        state: running
        wait: yes
      loop: "{{ ec2_instances }}"
      register: ec2_results

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 5: æ”¶é›† EC2 è³‡è¨Š
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Collect EC2 information
      set_fact:
        ec2_info:
          project_name: "{{ project_name }}"
          vpc_id: "{{ vpc_id }}"
          region: "{{ cluster_region }}"
          instances: "{{ ec2_results.results | map(attribute='instances') | flatten | list }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 6: é¡¯ç¤ºå»ºç«‹çµæœ
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Display EC2 Summary
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  âœ… EC2 å¯¦ä¾‹å»ºç«‹å®Œæˆ ({{ ec2_info.instances | length }} å°)"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "å°ˆæ¡ˆ: {{ ec2_info.project_name }}"
          - "VPC: {{ ec2_info.vpc_id }}"
          - "Region: {{ ec2_info.region }}"
          - ""
          - "{% for instance in ec2_info.instances %}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n{{ instance.tags.Name }}\n  Instance ID: {{ instance.instance_id }}\n  Instance Type: {{ instance.instance_type }}\n  Private IP: {{ instance.private_ip_address }}\n  {% if instance.public_ip_address is defined %}Public IP: {{ instance.public_ip_address }}\n  {% endif %}Subnet: {{ instance.tags.SubnetName }}\n  AZ: {{ instance.placement.availability_zone }}\n  State: {{ instance.state.name }}\n  {% if instance.tags.Role is defined %}Role: {{ instance.tags.Role }}\n  {% endif %}\n{% endfor %}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  ğŸ“‹ é€£ç·šæ–¹å¼"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "  æ–¹æ³• 1: SSH Key (å¦‚æœæœ‰è¨­å®š key_name)"
          - "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          - "{% for instance in ec2_info.instances %}{% if instance.public_ip_address is defined %}  ssh -i your-key.pem ec2-user@{{ instance.public_ip_address }}  # {{ instance.tags.Name }}\n{% endif %}{% endfor %}"
          - "{% for instance in ec2_info.instances %}{% if not instance.public_ip_address is defined %}  ssh -J ec2-user@<bastion-ip> ec2-user@{{ instance.private_ip_address }}  # {{ instance.tags.Name }} (é€é Bastion)\n{% endif %}{% endfor %}"
          - ""
          - "  æ–¹æ³• 2: AWS Session Manager (æ¨è–¦ï¼Œç„¡éœ€ Key)"
          - "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          - "{% for instance in ec2_info.instances %}  aws ssm start-session --target {{ instance.instance_id }} --region {{ ec2_info.region }}  # {{ instance.tags.Name }}\n{% endfor %}"
          - ""
          - "  Session Manager å„ªé»ï¼š"
          - "  âœ… ä¸éœ€è¦ SSH Key"
          - "  âœ… ä¸éœ€è¦é–‹æ”¾ Port 22"
          - "  âœ… é€é IAM æ¬Šé™æ§åˆ¶"
          - "  âœ… CloudTrail å®Œæ•´ç¨½æ ¸è¨˜éŒ„"
          - ""
          - "  âš ï¸  ä½¿ç”¨ Session Manager éœ€è¦ï¼š"
          - "  1. EC2 å®‰è£ SSM Agent (Amazon Linux 2/AL2023 é è¨­å·²å®‰è£)"
          - "  2. EC2 æœ‰ IAM Role: AmazonSSMManagedInstanceCore"
          - "  3. ç¶²è·¯å¯é€£åˆ° ssm.ap-northeast-1.amazonaws.com (æˆ–ä½¿ç”¨ VPC Endpoint)"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
