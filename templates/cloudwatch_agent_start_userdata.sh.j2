#!/bin/bash
# 建立 CloudWatch Agent 設定檔
mkdir -p /opt/aws/amazon-cloudwatch-agent/etc
cat >/opt/aws/amazon-cloudwatch-agent/etc/cloudwatch-agent.json <<'EOF'
{
  "agent": {
    "metrics_collection_interval": {{ metrics_collection_interval | default(60) }},
    "run_as_user": "root"
  },
  "metrics": {
    "namespace": "{{ cwagent_namespace | default('CWAgent') }}",
    "append_dimensions": {
      "InstanceId": "${aws:InstanceId}"
    },
    "metrics_collected": {
      "mem": {
        "measurement": [
          "mem_total",
          "mem_used",
          "mem_used_percent"
        ],
        "metrics_collection_interval": {{ metrics_collection_interval | default(60) }}
      },
      "disk": {
        "measurement": [
          "total",
          "used"
        ],
        "metrics_collection_interval": {{ metrics_collection_interval | default(60) }},
        "resources": [
          "*"
        ],
        "ignore_file_system_types": [
          "sysfs",
          "devtmpfs",
          "tmpfs",
          "squashfs",
          "efivarfs"
        ],
        "drop_device": false,
        "append_dimensions": {
          "VolumeId": "${aws:VolumeId}"
        }
      }
    }
  }
}
EOF

# 啟動 CloudWatch Agent
/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/cloudwatch-agent.json -s
