---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Step 2: åœ¨æŒ‡å®šçš„ Subnet å»ºç«‹ EC2 å¯¦ä¾‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä½¿ç”¨å ´æ™¯: Step 1 å»ºç«‹å®ŒåŸºç¤è¨­æ–½å¾Œï¼Œä½¿ç”¨æ­¤è…³æœ¬å»ºç«‹ EC2
# 
# å‰ç½®æ¢ä»¶:
#   1. Step 1 å·²åŸ·è¡Œå®Œæˆ
#   2. å·²æœ‰ {project_name}_infrastructure.yml æª”æ¡ˆ
#   3. å·²çŸ¥è¦éƒ¨ç½²åœ¨å“ªå€‹ Subnet
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: Step 2 - Create EC2 Instances in Specified Subnet
  hosts: localhost
  gather_facts: true
  
  vars:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # åŸºæœ¬è¨­å®š
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    aws_region: ap-northeast-1
    
    # âš ï¸ è¼‰å…¥ Step 1 ç”¢ç”Ÿçš„åŸºç¤è¨­æ–½è³‡è¨Š
    infrastructure_file: ProjectX-prod_infrastructure.yml
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # EC2 éƒ¨ç½²åƒæ•¸ (ä½¿ç”¨è€…ç”³è«‹å–®å¡«å¯«)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ec2_instances:
      # å¯¦ä¾‹ 1: Bastion Server (è·³æ¿æ©Ÿ)
      - name: bastion-01
        subnet_name: bastion              # éƒ¨ç½²åœ¨ bastion subnet
        instance_type: t3.micro           # è·³æ¿æ©Ÿç”¨å°è¦æ ¼å³å¯
        ami_id: ami-0d52744d6551d851e     # Amazon Linux 2023 (ap-northeast-1)
        key_name: my-keypair              # âš ï¸ æ”¹æˆä½ çš„ SSH Key
        private_ip: 10.100.1.10           # å›ºå®š IP (åœ¨ bastion subnet å…§)
        assign_public_ip: true            # Bastion éœ€è¦ Public IP
        volume_size: 20
        tags:
          Role: Bastion
          Environment: Production
      
      # å¯¦ä¾‹ 2-3: Application Servers
      - name: app-01
        subnet_name: app
        instance_type: t3.medium          # æ‡‰ç”¨ä¼ºæœå™¨ç”¨ä¸­ç­‰è¦æ ¼
        ami_id: ami-0d52744d6551d851e
        key_name: my-keypair
        private_ip: 10.100.10.10
        assign_public_ip: false           # App ä¸éœ€è¦ Public IP
        volume_size: 50
        tags:
          Role: Application
          Service: API
          Environment: Production
      
      - name: app-02
        subnet_name: app
        instance_type: t3.medium
        ami_id: ami-0d52744d6551d851e
        key_name: my-keypair
        private_ip: 10.100.10.11
        assign_public_ip: false
        volume_size: 50
        tags:
          Role: Application
          Service: API
          Environment: Production
      
      # å¯¦ä¾‹ 4: Database Server
      - name: db-01
        subnet_name: db
        instance_type: t3.large           # è³‡æ–™åº«ç”¨è¼ƒå¤§è¦æ ¼
        ami_id: ami-0d52744d6551d851e
        key_name: my-keypair
        private_ip: 10.100.20.10
        assign_public_ip: false           # DB çµ•å°ä¸è¦ Public IP
        volume_size: 100
        tags:
          Role: Database
          Engine: MySQL
          Environment: Production

  tasks:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 1: è¼‰å…¥åŸºç¤è¨­æ–½è³‡è¨Š
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Load infrastructure information
      include_vars:
        file: "{{ infrastructure_file }}"
        name: infra

    - name: Validate infrastructure data
      fail:
        msg: "åŸºç¤è¨­æ–½æª”æ¡ˆè¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª {{ infrastructure_file }} å­˜åœ¨"
      when: infra.vpc_id is not defined

    - name: Display loaded infrastructure info
      debug:
        msg:
          - "è¼‰å…¥åŸºç¤è¨­æ–½è³‡è¨Š:"
          - "  VPC ID: {{ infra.vpc_id }}"
          - "  å°ˆæ¡ˆåç¨±: {{ infra.project_name }}"
          - "  Subnets: {{ infra.subnets | length }} å€‹"
          - "  Security Groups: {{ infra.security_groups | length }} å€‹"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 2: å»ºç«‹ EC2 å¯¦ä¾‹
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create EC2 instances
      amazon.aws.ec2_instance:
        region: "{{ aws_region }}"
        name: "{{ infra.project_name }}-{{ item.name }}"
        instance_type: "{{ item.instance_type }}"
        image_id: "{{ item.ami_id }}"
        key_name: "{{ item.key_name }}"
        
        # å¾åŸºç¤è¨­æ–½è³‡è¨Šä¸­æ‰¾åˆ°å°æ‡‰çš„ Subnet ID
        vpc_subnet_id: "{{ (infra.subnets | selectattr('name', 'search', item.subnet_name) | first).subnet_id }}"
        
        # å¾åŸºç¤è¨­æ–½è³‡è¨Šä¸­æ‰¾åˆ°å°æ‡‰çš„ Security Group ID
        security_groups:
          - "{{ (infra.security_groups | selectattr('subnet', 'equalto', item.subnet_name) | first).sg_id }}"
        
        # ç¶²è·¯è¨­å®š
        network:
          assign_public_ip: "{{ item.assign_public_ip }}"
          private_ip_address: "{{ item.private_ip }}"
        
        # å„²å­˜è¨­å®š
        volumes:
          - device_name: /dev/xvda
            ebs:
              volume_size: "{{ item.volume_size }}"
              volume_type: gp3
              delete_on_termination: true
        
        # æ¨™ç±¤
        tags:
          Name: "{{ infra.project_name }}-{{ item.name }}"
          Project: "{{ infra.project_name }}"
          Subnet: "{{ item.subnet_name }}"
          ManagedBy: Ansible
          CreatedDate: "{{ ansible_date_time.date }}"
          "{{ item.tags | default({}) }}"
        
        state: running
        wait: yes
      loop: "{{ ec2_instances }}"
      register: ec2_results

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 3: å„²å­˜ EC2 è³‡è¨Š
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Save EC2 information to file
      copy:
        content: |
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # {{ infra.project_name }} EC2 å¯¦ä¾‹è³‡è¨Š
          # å»ºç«‹æ™‚é–“: {{ ansible_date_time.iso8601 }}
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          project_name: {{ infra.project_name }}
          vpc_id: {{ infra.vpc_id }}
          region: {{ aws_region }}
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # EC2 å¯¦ä¾‹æ¸…å–®
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ec2_instances:
          {% for result in ec2_results.results %}
          {% set instance = result.instances[0] %}
            - name: {{ instance.tags.Name }}
              instance_id: {{ instance.instance_id }}
              instance_type: {{ instance.instance_type }}
              private_ip: {{ instance.private_ip_address }}
              {% if instance.public_ip_address is defined %}
              public_ip: {{ instance.public_ip_address }}
              {% endif %}
              subnet: {{ instance.tags.Subnet }}
              subnet_id: {{ instance.subnet_id }}
              az: {{ instance.placement.availability_zone }}
              state: {{ instance.state.name }}
              launch_time: {{ instance.launch_time }}
              {% if instance.tags.Role is defined %}
              role: {{ instance.tags.Role }}
              {% endif %}
          {% endfor %}
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # é€£ç·šè³‡è¨Š
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # 
          # 1. é€£ç·šåˆ° Bastion (è·³æ¿æ©Ÿ):
          {% for result in ec2_results.results %}
          {% set instance = result.instances[0] %}
          {% if instance.tags.Subnet == 'bastion' %}
          #    ssh -i /path/to/key.pem ec2-user@{{ instance.public_ip_address }}
          {% endif %}
          {% endfor %}
          # 
          # 2. é€é Bastion è·³åˆ°å…§éƒ¨ä¼ºæœå™¨:
          {% for result in ec2_results.results %}
          {% set instance = result.instances[0] %}
          {% if instance.tags.Subnet != 'bastion' %}
          #    ssh -J ec2-user@<bastion-ip> ec2-user@{{ instance.private_ip_address }}  # {{ instance.tags.Name }}
          {% endif %}
          {% endfor %}
          # 
          # 3. æˆ–ä½¿ç”¨ SSH Config (~/.ssh/config):
          #    Host bastion
          #        HostName <bastion-public-ip>
          #        User ec2-user
          #        IdentityFile /path/to/key.pem
          #    
          #    Host app-*
          #        User ec2-user
          #        ProxyJump bastion
          #        IdentityFile /path/to/key.pem
          {% for result in ec2_results.results %}
          {% set instance = result.instances[0] %}
          {% if instance.tags.Subnet == 'app' %}
          #    
          #    Host {{ instance.tags.Name }}
          #        HostName {{ instance.private_ip_address }}
          {% endif %}
          {% endfor %}
          # 
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        dest: "./{{ infra.project_name }}_ec2_instances.yml"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 4: é¡¯ç¤ºå»ºç«‹çµæœ
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Display EC2 Summary
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  âœ… EC2 å¯¦ä¾‹å»ºç«‹å®Œæˆ ({{ ec2_results.results | length }} å°)"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "{% for result in ec2_results.results %}{% set instance = result.instances[0] %}{{ instance.tags.Name }}:\n  Instance ID: {{ instance.instance_id }}\n  Private IP: {{ instance.private_ip_address }}\n  {% if instance.public_ip_address is defined %}Public IP: {{ instance.public_ip_address }}\n  {% endif %}Subnet: {{ instance.tags.Subnet }}\n  State: {{ instance.state.name }}\n\n{% endfor %}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  ğŸ“‹ é€£ç·šæŒ‡ä»¤"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "{% for result in ec2_results.results %}{% set instance = result.instances[0] %}{% if instance.tags.Subnet == 'bastion' %}Bastion: ssh -i key.pem ec2-user@{{ instance.public_ip_address }}\n{% endif %}{% endfor %}"
          - "{% for result in ec2_results.results %}{% set instance = result.instances[0] %}{% if instance.tags.Subnet != 'bastion' %}{{ instance.tags.Name }}: ssh -J ec2-user@<bastion-ip> ec2-user@{{ instance.private_ip_address }}\n{% endif %}{% endfor %}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  ğŸ“„ è©³ç´°è³‡è¨Šå·²å„²å­˜"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "æª”æ¡ˆ: {{ infra.project_name }}_ec2_instances.yml"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
