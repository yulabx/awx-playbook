---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Step 1: å»ºç«‹ VPC å’Œå¤šå€‹ Subnet + å°æ‡‰çš„ Security Groups
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä½¿ç”¨å ´æ™¯: ç®¡ç†å“¡å¯©æ ¸ä½¿ç”¨è€…ç”³è«‹å¾Œï¼Œåˆ†é… CIDR ä¸¦åŸ·è¡Œæ­¤è…³æœ¬
# 
# å·¥ä½œæµç¨‹:
#   1. ä½¿ç”¨è€…åœ¨å‰ç«¯è¡¨å–®ç”³è«‹ (é¸æ“‡ Subnet æ•¸é‡ã€å¤§å°ã€é¡å‹ã€ç”¨é€”)
#   2. ç®¡ç†å“¡å¯©æ ¸å¾Œï¼Œåœ¨æ­¤æª”æ¡ˆå¡«å…¥å¯¦éš›åˆ†é…çš„ CIDR
#   3. åŸ·è¡Œæ­¤è…³æœ¬å»ºç«‹ VPCã€Subnetã€SGã€IGWã€Route Table
#   4. ç”¢ç”ŸåŸºç¤è¨­æ–½è³‡è¨Šæª”ï¼Œä¾› Step 2 å»ºç«‹ EC2 ä½¿ç”¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: Step 1 - Create VPC, Subnets and Security Groups
  hosts: localhost
  gather_facts: true
  
  vars:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # åŸºæœ¬è¨­å®š (å›ºå®šå€¼ - ä¸éœ€å¾ AWX Survey å‚³å…¥)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    aws_region: ap-northeast-1
    default_az: "{{ aws_region }}a"
    
    # å…¬å¸è¾¦å…¬å®¤å›ºå®š IP (ç”¨æ–¼ Bastion SSH é™åˆ¶)
    office_ip: "203.0.113.10/32"      # âš ï¸ æ”¹æˆå¯¦éš›çš„å…¬å¸ IP
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # å¾ AWX Survey / API å‚³å…¥çš„åƒæ•¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # project_name: "ProjectX-prod"   # â¬…ï¸ å¾ AWX Extra Variables å‚³å…¥
    # vpc_cidr: "10.100.0.0/16"       # â¬…ï¸ å¾ AWX Extra Variables å‚³å…¥
    # subnets: []                     # â¬…ï¸ å¾ AWX Extra Variables å‚³å…¥ (JSON é™£åˆ—)
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Subnet å®šç¾©ç¯„ä¾‹ (AWX Survey æœƒå‚³å…¥é¡ä¼¼æ ¼å¼)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # subnets:
    #   - name: bastion
    #     cidr: 10.100.1.0/28
    #     is_public: true
    #     purpose: "DMZ / è·³æ¿æ©Ÿå°ˆç”¨"
    #   
    #   - name: app
    #     cidr: 10.100.10.0/24
    #     is_public: false
    #     purpose: "å…§éƒ¨ API / æ‡‰ç”¨ä¼ºæœå™¨"
    #   
    #   - name: db
    #     cidr: 10.100.20.0/24
    #     is_public: false
    #     purpose: "è³‡æ–™åº«å°ˆç”¨"
    
    # âš ï¸ æ³¨æ„: subnets ä¸åŒ…å« 'az' æ¬„ä½ï¼Œç”±è…³æœ¬è‡ªå‹•åŠ ä¸Š
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Security Group è¦å‰‡å®šç¾©
    # âš ï¸ æ ¹æ“šå¯¦éš›çš„ subnet åç¨±å‹•æ…‹èª¿æ•´è¦å‰‡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 
    # è¦å‰‡èªªæ˜:
    # 1. æ¯å€‹ Subnet è‡ªå‹•å»ºç«‹å°æ‡‰çš„ Security Group
    # 2. æ‰€æœ‰ Subnet éƒ½å…è¨±å¾ Bastion SSH (å¦‚æœæœ‰ bastion)
    # 3. å…¶ä»–è¦å‰‡éœ€è¦åœ¨å»ºç«‹å¾Œæ‰‹å‹•èª¿æ•´ï¼Œæˆ–ä½¿ç”¨ purpose æ¬„ä½åˆ¤æ–·
    # 
    # å»ºè­°åšæ³•:
    #   - purpose åŒ…å« "DMZ" æˆ– "Bastion" â†’ åªé–‹æ”¾å…¬å¸ IP çš„ SSH
    #   - purpose åŒ…å« "APP" æˆ– "Web" â†’ é–‹æ”¾å…§éƒ¨ API åŸ 
    #   - purpose åŒ…å« "DB" æˆ– "Database" â†’ åªé–‹æ”¾è³‡æ–™åº«åŸ çµ¦ App
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    # å‹•æ…‹ç”¢ç”Ÿ Security Groups (æ¯å€‹ Subnet ä¸€å€‹ SG)
    security_groups: []
    
    # âš ï¸ å¦‚éœ€è‡ªè¨‚è¦å‰‡ï¼Œè«‹åœ¨ä¸‹æ–¹ Task æ‰‹å‹•å»ºç«‹
    # æˆ–ä½¿ç”¨ purpose æ¬„ä½åœ¨ Task ä¸­å‹•æ…‹åˆ¤æ–·

  tasks:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 1: å»ºç«‹ VPC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create VPC
      amazon.aws.ec2_vpc_net:
        region: "{{ aws_region }}"
        name: "{{ project_name }}-VPC"
        cidr_block: "{{ vpc_cidr }}"
        tags:
          Name: "{{ project_name }}-VPC"
          Project: "{{ project_name }}"
          ManagedBy: Ansible
          CreatedDate: "{{ ansible_date_time.date }}"
        state: present
      register: vpc_result

    - name: Save VPC ID
      set_fact:
        vpc_id: "{{ vpc_result.vpc.id }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 2: å»ºç«‹ Internet Gateway (for Public Subnet)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create Internet Gateway
      amazon.aws.ec2_vpc_igw:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        tags:
          Name: "{{ project_name }}-IGW"
          Project: "{{ project_name }}"
          ManagedBy: Ansible
        state: present
      register: igw_result
      when: subnets | selectattr('is_public', 'equalto', true) | list | length > 0

    - name: Save IGW ID
      set_fact:
        igw_id: "{{ igw_result.gateway_id }}"
      when: igw_result is defined and igw_result.gateway_id is defined

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 3: å»ºç«‹æ‰€æœ‰ Subnets (è‡ªå‹•åŠ ä¸Š AZ)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create Subnets
      amazon.aws.ec2_vpc_subnet:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        cidr: "{{ item.cidr }}"
        az: "{{ item.az | default(default_az) }}"  # å¦‚æœæ²’æœ‰ azï¼Œä½¿ç”¨ default_az
        map_public: "{{ item.is_public }}"
        tags:
          Name: "{{ project_name }}-{{ item.name }}-subnet"
          Project: "{{ project_name }}"
          Purpose: "{{ item.purpose }}"
          Type: "{{ 'Public' if item.is_public else 'Private' }}"
          CIDR: "{{ item.cidr }}"
          ManagedBy: Ansible
        state: present
      loop: "{{ subnets }}"
      register: subnet_results

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 4: å»ºç«‹ Public Route Table (for Public Subnets)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Get Public Subnet IDs
      set_fact:
        public_subnet_ids: "{{ subnet_results.results | 
                               selectattr('subnet.map_public_ip_on_launch', 'equalto', true) | 
                               map(attribute='subnet.id') | list }}"

    - name: Create Public Route Table
      amazon.aws.ec2_vpc_route_table:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        tags:
          Name: "{{ project_name }}-RT-Public"
          Project: "{{ project_name }}"
          Type: Public
          ManagedBy: Ansible
        subnets: "{{ public_subnet_ids }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ igw_id }}"
        state: present
      register: public_rt_result
      when: 
        - public_subnet_ids | length > 0
        - igw_id is defined

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 5: å»ºç«‹ Private Route Table (for Private Subnets)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Get Private Subnet IDs
      set_fact:
        private_subnet_ids: "{{ subnet_results.results | 
                                selectattr('subnet.map_public_ip_on_launch', 'equalto', false) | 
                                map(attribute='subnet.id') | list }}"

    - name: Create Private Route Table
      amazon.aws.ec2_vpc_route_table:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        tags:
          Name: "{{ project_name }}-RT-Private"
          Project: "{{ project_name }}"
          Type: Private
          ManagedBy: Ansible
        subnets: "{{ private_subnet_ids }}"
        routes: []  # Private subnet æ²’æœ‰å°å¤–è·¯ç”± (é™¤éåŠ  NAT Gateway)
        state: present
      register: private_rt_result
      when: private_subnet_ids | length > 0

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 6: å‹•æ…‹å»ºç«‹ Security Groups (æ¯å€‹ Subnet ä¸€å€‹)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create Security Groups for each subnet
      amazon.aws.ec2_security_group:
        region: "{{ aws_region }}"
        name: "{{ project_name }}-{{ item.name }}-sg"
        description: "Security Group for {{ item.name }} subnet"
        vpc_id: "{{ vpc_id }}"
        tags:
          Name: "{{ project_name }}-{{ item.name }}-sg"
          Project: "{{ project_name }}"
          Subnet: "{{ item.name }}"
          Purpose: "{{ item.purpose }}"
          ManagedBy: Ansible
        
        # åŸºæœ¬è¦å‰‡: æ‰€æœ‰ Subnet éƒ½å…è¨±å¾ Bastion SSH (å¦‚æœæœ‰ bastion subnet)
        rules: >-
          {{
            ([{
              'proto': 'tcp',
              'from_port': 22,
              'to_port': 22,
              'cidr_ip': (subnets | selectattr('name', 'search', '[Bb]astion|[Dd][Mm][Zz]') | map(attribute='cidr') | first | default(office_ip)),
              'rule_desc': 'SSH from bastion or office'
            }] if not (item.purpose | lower is search('bastion|dmz')) else [{
              'proto': 'tcp',
              'from_port': 22,
              'to_port': 22,
              'cidr_ip': office_ip,
              'rule_desc': 'SSH from office IP only'
            }])
            +
            ([{
              'proto': 'tcp',
              'from_port': 8080,
              'to_port': 8080,
              'cidr_ip': vpc_cidr,
              'rule_desc': 'Internal API access'
            }] if (item.purpose | lower is search('app|api|web')) else [])
            +
            ([{
              'proto': 'tcp',
              'from_port': 3306,
              'to_port': 3306,
              'cidr_ip': vpc_cidr,
              'rule_desc': 'MySQL from VPC'
            },
            {
              'proto': 'tcp',
              'from_port': 5432,
              'to_port': 5432,
              'cidr_ip': vpc_cidr,
              'rule_desc': 'PostgreSQL from VPC'
            }] if (item.purpose | lower is search('db|database|è³‡æ–™åº«')) else [])
            +
            ([{
              'proto': 'tcp',
              'from_port': 6379,
              'to_port': 6379,
              'cidr_ip': vpc_cidr,
              'rule_desc': 'Redis from VPC'
            }] if (item.purpose | lower is search('cache|redis')) else [])
          }}
        
        # Outbound è¦å‰‡
        rules_egress:
          - proto: all
            cidr_ip: 0.0.0.0/0
            rule_desc: "Allow all outbound"
        
        state: present
      loop: "{{ subnets }}"
      register: sg_results

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 7: å»ºç«‹ SSH Key Pair
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create SSH Key Pair for this project
      amazon.aws.ec2_key:
        region: "{{ aws_region }}"
        name: "{{ project_name }}-keypair"
        state: present
      register: keypair_result
    
    - name: Set key pair info
      set_fact:
        key_name: "{{ project_name }}-keypair"
        private_key_content: "{{ keypair_result.key.private_key | default('') }}"
        is_new_key: "{{ keypair_result.key.private_key is defined }}"
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 8: å„²å­˜ç§é‘°åˆ° AWS Secrets Manager (ä¼æ¥­ç´šå®‰å…¨å„²å­˜)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Store private key in AWS Secrets Manager
      community.aws.secretsmanager_secret:
        region: "{{ aws_region }}"
        name: "{{ project_name }}/ssh-keypair"
        description: "SSH Private Key for project {{ project_name }}"
        secret_type: "string"
        secret: "{{ private_key_content }}"
        tags:
          Project: "{{ project_name }}"
          ManagedBy: "AWX-Ansible"
          CreatedAt: "{{ ansible_date_time.iso8601 }}"
          KeyName: "{{ key_name }}"
          Purpose: "EC2 SSH Access"
        state: present
      when: is_new_key | bool
      register: secrets_result
      ignore_errors: yes

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 8: å„²å­˜åŸºç¤è¨­æ–½è³‡è¨Šåˆ°æª”æ¡ˆ (ä¾› Step 2 ä½¿ç”¨)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Save infrastructure information to file
      copy:
        content: |
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # {{ project_name }} åŸºç¤è¨­æ–½è³‡è¨Š
          # å»ºç«‹æ™‚é–“: {{ ansible_date_time.iso8601 }}
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          vpc_id: {{ vpc_id }}
          vpc_cidr: {{ vpc_cidr }}
          region: {{ aws_region }}
          project_name: {{ project_name }}
          key_name: {{ project_name }}-keypair
          {% if igw_id is defined %}
          igw_id: {{ igw_id }}
          {% endif %}
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Subnets è³‡è¨Š
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          subnets:
          {% for result in subnet_results.results %}
            - name: {{ result.subnet.tags.Name }}
              subnet_id: {{ result.subnet.id }}
              cidr: {{ result.subnet.cidr_block }}
              az: {{ result.subnet.availability_zone }}
              type: {{ result.subnet.tags.Type }}
              purpose: {{ result.subnet.tags.Purpose }}
              is_public: {{ result.subnet.map_public_ip_on_launch }}
          {% endfor %}
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Security Groups è³‡è¨Š
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          security_groups:
          {% for result in sg_results.results %}
            - name: {{ result.group_name }}
              sg_id: {{ result.group_id }}
              subnet: {{ result.tags.Subnet }}
              description: {{ result.description }}
          {% endfor %}
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Route Tables è³‡è¨Š
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          route_tables:
          {% if public_rt_result is defined and public_rt_result.route_table is defined %}
            - name: {{ project_name }}-RT-Public
              rt_id: {{ public_rt_result.route_table.id }}
              type: Public
              subnets: {{ public_subnet_ids }}
          {% endif %}
          {% if private_rt_result is defined and private_rt_result.route_table is defined %}
            - name: {{ project_name }}-RT-Private
              rt_id: {{ private_rt_result.route_table.id }}
              type: Private
              subnets: {{ private_subnet_ids }}
          {% endif %}
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ä½¿ç”¨èªªæ˜
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # æ­¤æª”æ¡ˆåŒ…å«æ‰€æœ‰åŸºç¤è¨­æ–½çš„ ID è³‡è¨Š
          # è«‹åœ¨ Step 2 å»ºç«‹ EC2 æ™‚ä½¿ç”¨å°æ‡‰çš„ subnet_id å’Œ sg_id
          # 
          # ç¶²è·¯æ¶æ§‹:
          {% for subnet in subnets %}
          #   - {{ subnet.name }}: {{ subnet.cidr }} ({{ 'Public' if subnet.is_public else 'Private' }}) - {{ subnet.purpose }}
          {% endfor %}
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        dest: "./{{ project_name }}_infrastructure.yml"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 9: é¡¯ç¤ºæ‘˜è¦è³‡è¨Š
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Display Summary
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  âœ… VPC å»ºç«‹å®Œæˆ"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "VPC ID: {{ vpc_id }}"
          - "VPC CIDR: {{ vpc_cidr }}"
          - "Region: {{ aws_region }}"
          - "SSH Key: {{ project_name }}-keypair"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  âœ… Subnets ({{ subnet_results.results | length }} å€‹)"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "{% for result in subnet_results.results %}{{ result.subnet.tags.Name }}: {{ result.subnet.id }} ({{ result.subnet.cidr_block }}) - {{ result.subnet.tags.Type }}\n{% endfor %}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  âœ… Security Groups ({{ sg_results.results | length }} å€‹)"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "{% for result in sg_results.results %}{{ result.group_name }}: {{ result.group_id }}\n{% endfor %}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "  ğŸ“„ åŸºç¤è¨­æ–½è³‡è¨Šå·²å„²å­˜"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "æª”æ¡ˆ: {{ project_name }}_infrastructure.yml"
          - ""
    - name: Summary
      debug:
        msg:
          - "âœ… VPC å»ºç«‹å®Œæˆ"
          - "âœ… {{ subnets | length }} å€‹ Subnet å»ºç«‹å®Œæˆ"
          - "âœ… {{ subnets | length }} å€‹ Security Group å»ºç«‹å®Œæˆ"
          - "âœ… SSH Key Pair: {{ key_name }}"
          - "âœ… Internet Gateway å’Œ Route Table è¨­å®šå®Œæˆ"
          - "{% if is_new_key | bool %}âœ… ç§é‘°å·²å®‰å…¨å„²å­˜è‡³ AWS Secrets Manager{% endif %}"
          - ""
          - "ğŸ¯ ä¸‹ä¸€æ­¥: ä½¿ç”¨ step2_create_ec2_dynamic.yml å»ºç«‹ EC2"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 10: é¡¯ç¤ºç§é‘°ä¸‹è¼‰æ–¹å¼ (æ–°å»ºç«‹æ™‚)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Display private key download instructions
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  ğŸ” å°ˆæ¡ˆ SSH ç§é‘°å·²å»ºç«‹                                  â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Key Name: {{ key_name }}"
          - "Secret Name: {{ project_name }}/ssh-keypair"
          - "å„²å­˜ä½ç½®: AWS Secrets Manager ({{ aws_region }})"
          - ""
          - "ğŸ“¥ å°ˆæ¡ˆæˆå“¡ä¸‹è¼‰ç§é‘°æ–¹å¼ï¼š"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "æ–¹æ³• 1: ä½¿ç”¨ AWX è‡ªåŠ©ä¸‹è¼‰ (æ¨è–¦)"
          - "  1. åœ¨ AWX åŸ·è¡Œ Job Template: 'Download Project SSH Key'"
          - "  2. è¼¸å…¥å°ˆæ¡ˆåç¨±: {{ project_name }}"
          - "  3. å¾ Job è¼¸å‡ºè¤‡è£½ç§é‘°ä¸¦å„²å­˜ç‚º .pem æª”æ¡ˆ"
          - ""
          - "æ–¹æ³• 2: ä½¿ç”¨ AWS CLI"
          - "  aws secretsmanager get-secret-value \\"
          - "    --region {{ aws_region }} \\"
          - "    --secret-id '{{ project_name }}/ssh-keypair' \\"
          - "    --query 'SecretString' \\"
          - "    --output text > {{ key_name }}.pem"
          - "  chmod 400 {{ key_name }}.pem"
          - ""
          - "æ–¹æ³• 3: ä½¿ç”¨ AWS Console"
          - "  1. å‰å¾€ Secrets Manager ({{ aws_region }})"
          - "  2. æœå°‹: {{ project_name }}/ssh-keypair"
          - "  3. é»æ“Š Secret â†’ Retrieve secret value"
          - "  4. è¤‡è£½å…§å®¹å„²å­˜ç‚º {{ key_name }}.pem"
          - ""
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "ğŸ”’ å®‰å…¨æ€§èªªæ˜ï¼š"
          - "  âœ… ç§é‘°ä½¿ç”¨ AWS KMS åŠ å¯†å„²å­˜"
          - "  âœ… éœ€è¦ IAM æ¬Šé™æ‰èƒ½è®€å– (secretsmanager:GetSecretValue)"
          - "  âœ… æ‰€æœ‰å­˜å–éƒ½æœ‰ CloudTrail ç¨½æ ¸è¨˜éŒ„"
          - "  âœ… å°ˆæ¡ˆæ‰€æœ‰ EC2 éƒ½ä½¿ç”¨æ­¤é‡‘é‘° ({{ key_name }})"
          - ""
          - "âš ï¸  é‡è¦æé†’ï¼š"
          - "  â€¢ è«‹é€šçŸ¥å°ˆæ¡ˆæˆå“¡ä¸‹è¼‰ä¸¦å¦¥å–„ä¿ç®¡ç§é‘°"
          - "  â€¢ æ­¤ç§é‘°æœƒç”¨æ–¼æ‰€æœ‰æœªä¾†å»ºç«‹çš„ EC2 å¯¦ä¾‹"
          - "  â€¢ é›¢è·äººå“¡è«‹ç«‹å³æ’¤éŠ· Secrets Manager å­˜å–æ¬Šé™"
          - "  â€¢ å¦‚ç§é‘°æ´©æ¼ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡æ›´æ›é‡‘é‘°å°"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      when: is_new_key | bool
    
    - name: Key already exists notice
      debug:
        msg:
          - "â„¹ï¸  SSH Key Pair '{{ key_name }}' å·²å­˜åœ¨"
          - ""
          - "ğŸ“¥ å°ˆæ¡ˆæˆå“¡å¯éš¨æ™‚é€éä»¥ä¸‹æ–¹å¼å–å¾—ç§é‘°ï¼š"
          - "  â€¢ AWX Job Template: 'Download Project SSH Key'"
          - "  â€¢ AWS CLI: aws secretsmanager get-secret-value --secret-id '{{ project_name }}/ssh-keypair'"
          - "  â€¢ AWS Console: Secrets Manager > {{ project_name }}/ssh-keypair"
          - ""
          - "å¦‚éœ€æ›´æ›é‡‘é‘°ï¼Œè«‹ï¼š"
          - "  1. åˆªé™¤ EC2 Key Pair: aws ec2 delete-key-pair --key-name {{ key_name }}"
          - "  2. åˆªé™¤ Secret: aws secretsmanager delete-secret --secret-id '{{ project_name }}/ssh-keypair'"
          - "  3. é‡æ–°åŸ·è¡Œæ­¤è…³æœ¬ç”¢ç”Ÿæ–°é‡‘é‘°"
      when: not (is_new_key | bool)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Display private key retrieval instructions
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  ğŸ” SSH ç§é‘°å·²å®‰å…¨å„²å­˜æ–¼ AWS Parameter Store            â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Key Name: {{ key_name }}"
          - "Parameter Path: /{{ project_name }}/keypair/{{ key_name }}"
          - ""
          - "ğŸ“¥ æ–¹æ³• 1: ä½¿ç”¨ AWS CLI ä¸‹è¼‰ (æ¨è–¦)"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "aws ssm get-parameter \\"
          - "  --region {{ aws_region }} \\"
          - "  --name '/{{ project_name }}/keypair/{{ key_name }}' \\"
          - "  --with-decryption \\"
          - "  --query 'Parameter.Value' \\"
          - "  --output text > {{ key_name }}.pem"
          - ""
          - "chmod 400 {{ key_name }}.pem"
          - ""
          - "ğŸ“¥ æ–¹æ³• 2: ä½¿ç”¨ AWS Console"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "1. å‰å¾€ AWS Systems Manager > Parameter Store"
          - "2. å€åŸŸé¸æ“‡: {{ aws_region }}"
          - "3. æœå°‹: /{{ project_name }}/keypair/{{ key_name }}"
          - "4. é»æ“Šåƒæ•¸åç¨± > Show > è¤‡è£½å…§å®¹"
          - "5. å„²å­˜ç‚º {{ key_name }}.pem"
          - ""
          - "ğŸ“¥ æ–¹æ³• 3: ä½¿ç”¨ AWX å»ºç«‹ä¸‹è¼‰ Job Template"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "å»ºç«‹æ–°çš„ Playbook è®€å– Parameter Store ä¸¦é¡¯ç¤º"
          - "(å¯æä¾›çµ¦ä½¿ç”¨è€…è‡ªåŠ©ä¸‹è¼‰)"
          - ""
          - "ğŸ”’ å®‰å…¨æ€§èªªæ˜ï¼š"
          - "  - ç§é‘°ä½¿ç”¨ AWS KMS åŠ å¯†å„²å­˜"
          - "  - éœ€è¦ IAM æ¬Šé™æ‰èƒ½è®€å–"
          - "  - æœ‰å®Œæ•´çš„å­˜å–è¨˜éŒ„ (CloudTrail)"
          - "  - ä¸æœƒå‡ºç¾åœ¨ AWX Job è¼¸å‡º (é¿å…æ´©æ¼)"
          - ""
          - "âš ï¸  è«‹é€šçŸ¥ä½¿ç”¨è€…é€é AWS CLI/Console ä¸‹è¼‰ç§é‘°"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      when: is_new_key | bool
    
    - name: Key already exists notice
      debug:
        msg:
          - "â„¹ï¸  SSH Key Pair '{{ key_name }}' å·²å­˜åœ¨"
          - ""
          - "ğŸ“¥ å–å¾—ç§é‘°æ–¹å¼ï¼š"
          - "aws ssm get-parameter --region {{ aws_region }} --name '/{{ project_name }}/keypair/{{ key_name }}' --with-decryption --query 'Parameter.Value' --output text > {{ key_name }}.pem"
          - ""
          - "å¦‚ç§é‘°éºå¤±ä¸”ç„¡æ³•å¾ Parameter Store å–å¾—ï¼Œè«‹ï¼š"
          - "1. åˆªé™¤ç¾æœ‰ Key Pair: aws ec2 delete-key-pair --region {{ aws_region }} --key-name {{ key_name }}"
          - "2. é‡æ–°åŸ·è¡Œæ­¤è…³æœ¬ç”¢ç”Ÿæ–°çš„ Key Pair"
      when: not (is_new_key | bool)
