---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Step 1: å»ºç«‹ VPC / Subnets / Security Groups / Route Tables
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: Step 1 - Create VPC, Subnets and Security Groups
  hosts: localhost
  gather_facts: true

  vars:
    aws_region: ap-northeast-1
    default_az: "{{ aws_region }}a"

    office_ip: "203.0.113.10/32"  # ä¿®æ”¹æˆå…¬å¸å¯¦éš› IP

    # subnets / project_name / vpc_cidr ç”±å¤–éƒ¨ AWX Survey å‚³å…¥

  tasks:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 1: å»ºç«‹ VPC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create VPC
      amazon.aws.ec2_vpc_net:
        region: "{{ aws_region }}"
        name: "{{ project_name }}-VPC"
        cidr_block: "{{ vpc_cidr }}"
        tags:
          Name: "{{ project_name }}-VPC"
          Project: "{{ project_name }}"
          ManagedBy: Ansible
          CreatedDate: "{{ ansible_date_time.date }}"
        state: present
      register: vpc_result

    - name: Save VPC ID
      set_fact:
        vpc_id: "{{ vpc_result.vpc.id }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 2: å»ºç«‹ Internet Gatewayï¼ˆå¦‚æœæœ‰ Public Subnetï¼‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create Internet Gateway
      amazon.aws.ec2_vpc_igw:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        tags:
          Name: "{{ project_name }}-IGW"
          Project: "{{ project_name }}"
          ManagedBy: Ansible
        state: present
      when: subnets | selectattr('is_public', 'equalto', true) | list | length > 0
      register: igw_result

    - name: Save IGW ID
      set_fact:
        igw_id: "{{ igw_result.gateway_id }}"
      when: igw_result is defined and igw_result.gateway_id is defined

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 3: å»ºç«‹ Subnets
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create Subnets
      amazon.aws.ec2_vpc_subnet:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        cidr: "{{ item.cidr }}"
        az: "{{ item.az | default(default_az) }}"
        map_public: "{{ item.is_public }}"
        tags:
          Name: "{{ project_name }}-{{ item.name }}-subnet"
          Project: "{{ project_name }}"
          Purpose: "{{ item.purpose }}"
          Type: "{{ 'Public' if item.is_public else 'Private' }}"
          CIDR: "{{ item.cidr }}"
          ManagedBy: Ansible
        state: present
      loop: "{{ subnets }}"
      register: subnet_results

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 4: Public Route Table
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Get Public Subnet IDs
      set_fact:
        public_subnet_ids: "{{ subnet_results.results |
                               selectattr('subnet.map_public_ip_on_launch','equalto',true) |
                               map(attribute='subnet.id') | list }}"

    - name: Create Public Route Table
      amazon.aws.ec2_vpc_route_table:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        tags:
          Name: "{{ project_name }}-RT-Public"
          Project: "{{ project_name }}"
          Type: Public
          ManagedBy: Ansible
        subnets: "{{ public_subnet_ids }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ igw_id }}"
        state: present
      when:
        - public_subnet_ids | length > 0
        - igw_id is defined
      register: public_rt_result

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 5: Private Route Table
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Get Private Subnet IDs
      set_fact:
        private_subnet_ids: "{{ subnet_results.results |
                                selectattr('subnet.map_public_ip_on_launch','equalto',false) |
                                map(attribute='subnet.id') | list }}"

    - name: Create Private Route Table
      amazon.aws.ec2_vpc_route_table:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        tags:
          Name: "{{ project_name }}-RT-Private"
          Project: "{{ project_name }}"
          Type: Private
          ManagedBy: Ansible
        subnets: "{{ private_subnet_ids }}"
        routes: []   # Private subnet é»˜è®¤æ—  NAT
        state: present
      when: private_subnet_ids | length > 0
      register: private_rt_result

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 6: Security Groupsï¼ˆæ¯å€‹ Subnet ä¸€å€‹ï¼‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create Security Groups
      amazon.aws.ec2_security_group:
        region: "{{ aws_region }}"
        name: "{{ project_name }}-{{ item.name }}-sg"
        description: "Security Group for {{ item.name }} subnet"
        vpc_id: "{{ vpc_id }}"
        tags:
          Name: "{{ project_name }}-{{ item.name }}-sg"
          Project: "{{ project_name }}"
          Subnet: "{{ item.name }}"
          Purpose: "{{ item.purpose }}"
          ManagedBy: Ansible

        rules: >-
          {{
            ([{
              'proto':'tcp','from_port':22,'to_port':22,
              'cidr_ip': office_ip,
              'rule_desc':'SSH from office'
            }])
            +
            ([{
              'proto':'tcp','from_port':8080,'to_port':8080,
              'cidr_ip': vpc_cidr,'rule_desc':'Internal API'
            }] if (item.purpose | lower is search('app|api|web')) else [])
            +
            ([{
              'proto':'tcp','from_port':3306,'to_port':3306,
              'cidr_ip': vpc_cidr,'rule_desc':'MySQL'
            },
            {
              'proto':'tcp','from_port':5432,'to_port':5432,
              'cidr_ip': vpc_cidr,'rule_desc':'PostgreSQL'
            }] if (item.purpose | lower is search('db|database')) else [])
          }}

        rules_egress:
          - proto: all
            cidr_ip: 0.0.0.0/0

        state: present
      loop: "{{ subnets }}"
      register: sg_results

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 7: å»ºç«‹ SSH Key Pair
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Create SSH Key Pair
      amazon.aws.ec2_key:
        region: "{{ aws_region }}"
        name: "{{ project_name }}-keypair"
        state: present
      register: keypair_result

    - name: Set key info
      set_fact:
        key_name: "{{ project_name }}-keypair }}"
        private_key_content: "{{ keypair_result.key.private_key | default('') }}"
        is_new_key: "{{ keypair_result.key.private_key is defined }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 8: å„²å­˜ SSH ç§é‘°ï¼ˆSecrets Managerï¼‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Store private key in Secrets Manager
      community.aws.aws_secret:
        region: "{{ aws_region }}"
        name: "{{ project_name }}/ssh-keypair"
        description: "SSH keypair for {{ project_name }}"
        secret_type: "string"
        secret: "{{ private_key_content }}"
        tags:
          Project: "{{ project_name }}"
          ManagedBy: "AWX"
      when: is_new_key | bool
      register: secrets_result

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 9: å„²å­˜åŸºç¤è¨­æ–½æª”æ¡ˆ
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Save info file
      copy:
        content: |
          project_name: {{ project_name }}
          vpc_id: {{ vpc_id }}
          vpc_cidr: {{ vpc_cidr }}

          subnets:
          {% for s in subnet_results.results %}
            - name: {{ s.subnet.tags.Name }}
              id: {{ s.subnet.id }}
              cidr: {{ s.subnet.cidr_block }}
              type: {{ s.subnet.tags.Type }}
          {% endfor %}

          security_groups:
          {% for sg in sg_results.results %}
            - name: {{ sg.group_name }}
              id: {{ sg.group_id }}
          {% endfor %}
        dest: "./{{ project_name }}_infrastructure.yml"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 10: Summary
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Summary
      debug:
        msg:
          - "VPC: {{ vpc_id }}"
          - "Subnets: {{ subnets | length }}"
          - "Security Groups: {{ sg_results.results | length }}"
          - "SSH Key: {{ key_name }}"
          - "Infrastructure file saved"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 11: ç§é‘°èªªæ˜ï¼ˆè‹¥æ–°å»ºç«‹ï¼‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: New SSH key instructions
      debug:
        msg:
          - "ğŸ” æ–° SSH ç§é‘°å·²å„²å­˜æ–¼ Secrets Manager"
          - "Secret ID: {{ project_name }}/ssh-keypair"
          - ""
          - "ä¸‹è¼‰æ–¹å¼ï¼š"
          - "aws secretsmanager get-secret-value --region {{ aws_region }} --secret-id '{{ project_name }}/ssh-keypair' --query 'SecretString' --output text > {{ key_name }}.pem"
      when: is_new_key | bool

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Task 12: ç§é‘°å·²å­˜åœ¨
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Existing SSH key notice
      debug:
        msg:
          - "â„¹ï¸ SSH Key '{{ key_name }}' å·²å­˜åœ¨"
          - "å¦‚éœ€ä¸‹è¼‰ï¼š"
          - "aws secretsmanager get-secret-value --region {{ aws_region }} --secret-id '{{ project_name }}/ssh-keypair'"
      when: not (is_new_key | bool)
