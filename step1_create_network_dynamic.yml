---
# Step 1: Create VPC / Subnets / Security Groups / Route Tables / SSH Key

- name: Step 1 - Create VPC, Subnets, Security Groups
  hosts: localhost
  gather_facts: true
  collections:
    - amazon.aws

  vars:
    aws_region: ap-northeast-1
    default_az: "{{ aws_region }}a"
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # å¤–éƒ¨ SSH å­˜å–æ§åˆ¶ (å®‰å…¨è¨­å®š)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_external_ssh: true           # æ˜¯å¦å…è¨±å¤–éƒ¨ SSH (true=æ¸¬è©¦, false=ç”Ÿç”¢)
    office_ip: "0.0.0.0/0"              # å…è¨± SSH çš„ä¾†æº IP (ç©ºå­—ä¸²=ä¸é–‹æ”¾)
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # å¾ AWX Survey / API å‚³å…¥çš„åƒæ•¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # project_name: "ita"                    # å°ˆæ¡ˆåç¨±
    # project_labels:                        # å°ˆæ¡ˆæ¨™ç±¤
    #   env: "dev"
    #   project.id: "ita"
    # vpc_cidr: "10.20.0.0/16"               # VPC CIDR
    # subnets:                               # Subnet åˆ—è¡¨ (ç‰©ä»¶é™£åˆ—)
    #   - name: "bastion"                    # Subnet åç¨±
    #     cidr: "10.20.1.0/28"               # CIDR
    #     is_public: true                    # æ˜¯å¦ç‚º Public Subnet
    #     purpose: "bastion"                 # ç”¨é€”
    #   - name: "app"
    #     cidr: "10.20.10.0/24"
    #     is_public: false
    #     purpose: "application"

  tasks:

    - name: Create VPC
      amazon.aws.ec2_vpc_net:
        region: "{{ aws_region }}"
        name: "{{ project_name }}-vpc"
        cidr_block: "{{ vpc_cidr }}"
        state: present
        tags:
          Name: "{{ project_name }}-vpc"
          Project: "{{ project_name }}"
          Env: "{{ project_labels.env }}"
          ProjectId: "{{ project_labels['project.id'] }}"
          ManagedBy: Ansible
      register: vpc_result

    - name: Set VPC ID
      set_fact:
        vpc_id: "{{ vpc_result.vpc.id }}"

    - name: Create Internet Gateway
      amazon.aws.ec2_vpc_igw:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        state: present
        tags:
          Name: "{{ project_name }}-igw"
          Project: "{{ project_name }}"
          Env: "{{ project_labels.env }}"
      when: subnets | selectattr('is_public','equalto',true) | list | length > 0
      register: igw_result

    - name: Set IGW ID
      set_fact:
        igw_id: "{{ igw_result.gateway_id }}"
      when: igw_result.gateway_id is defined

    - name: Create Subnets
      amazon.aws.ec2_vpc_subnet:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        cidr: "{{ item.cidr }}"
        az: "{{ item.az | default(default_az) }}"
        map_public: "{{ item.is_public }}"
        state: present
        tags:
          Name: "{{ project_name }}-{{ item.name }}-subnet"
          Project: "{{ project_name }}"
          SubnetName: "{{ item.name }}"
          Purpose: "{{ item.purpose }}"
          Type: "{{ 'Public' if item.is_public else 'Private' }}"
          Env: "{{ project_labels.env }}"
      loop: "{{ subnets }}"
      register: subnet_results

    - name: Get public subnets
      set_fact:
        public_subnet_ids: "{{ subnet_results.results |
                               selectattr('subnet.map_public_ip_on_launch','equalto',true) |
                               map(attribute='subnet.id') | list }}"

    - name: Create public route table
      amazon.aws.ec2_vpc_route_table:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        state: present
        subnets: "{{ public_subnet_ids }}"
        tags:
          Name: "{{ project_name }}-rt-public"
          Project: "{{ project_name }}"
          Env: "{{ project_labels.env }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ igw_id }}"
      when:
        - public_subnet_ids | length > 0
        - igw_id is defined

    - name: Get private subnets
      set_fact:
        private_subnet_ids: "{{ subnet_results.results |
                                selectattr('subnet.map_public_ip_on_launch','equalto',false) |
                                map(attribute='subnet.id') | list }}"

    - name: Create private route table
      amazon.aws.ec2_vpc_route_table:
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id }}"
        state: present
        subnets: "{{ private_subnet_ids }}"
        tags:
          Name: "{{ project_name }}-rt-private"
          Project: "{{ project_name }}"
          Env: "{{ project_labels.env }}"
        routes: []
      when: private_subnet_ids | length > 0

    - name: Create Security Groups for each subnet
      amazon.aws.ec2_security_group:
        region: "{{ aws_region }}"
        name: "{{ project_name }}-{{ item.name }}-sg"
        description: "Security Group for {{ item.name }} subnet"
        vpc_id: "{{ vpc_id }}"
        state: present
        tags:
          Name: "{{ project_name }}-{{ item.name }}-sg"
          Project: "{{ project_name }}"
          SubnetName: "{{ item.name }}"
          Env: "{{ project_labels.env }}"
        rules: >
          {%- set base_rules = [{'proto': 'all', 'cidr_ip': vpc_cidr}] -%}
          {%- if enable_external_ssh and office_ip != '' -%}
            {{ base_rules + [{'proto': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_ip': office_ip}] }}
          {%- else -%}
            {{ base_rules }}
          {%- endif -%}
        rules_egress:
          - proto: all
            cidr_ip: 0.0.0.0/0
      loop: "{{ subnets }}"
      register: sg_results

    - name: Create key pair
      amazon.aws.ec2_key:
        region: "{{ aws_region }}"
        name: "{{ project_name }}-keypair"
        state: present
        tags:
          Project: "{{ project_name }}"
          Env: "{{ project_labels.env }}"
          ManagedBy: Ansible
      register: keypair_result

    - name: Set key info
      set_fact:
        key_name: "{{ project_name }}-keypair"
        private_key_content: "{{ keypair_result.key.private_key | default('') }}"
        is_new_key: "{{ keypair_result.key.private_key is defined }}"

    - name: Summary
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… VPC å»ºç«‹å®Œæˆ"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "VPC ID: {{ vpc_id }}"
          - "Region: {{ aws_region }}"
          - "Subnets: {{ subnets | length }} å€‹"
          - "Security Groups: {{ sg_results.results | length }} å€‹"
          - "SSH Key: {{ key_name }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: Display SSH Private Key
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  ğŸ” SSH ç§é‘° (è«‹ç«‹å³è¤‡è£½å„²å­˜ï¼)                      â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Key Name: {{ key_name }}"
          - ""
          - "è«‹å°‡ä»¥ä¸‹å…§å®¹å„²å­˜ç‚º {{ key_name }}.pemï¼š"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "{{ private_key_content }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "Linux/Mac ä½¿ç”¨ï¼š"
          - "  chmod 400 {{ key_name }}.pem"
          - "  ssh -i {{ key_name }}.pem ec2-user@<IP>"
          - ""
          - "âš ï¸  æ­¤ç§é‘°åªæœƒé¡¯ç¤ºä¸€æ¬¡ï¼Œè«‹å‹™å¿…ç«‹å³å„²å­˜ï¼"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      when: is_new_key | bool
    
    - name: Key already exists
      debug:
        msg:
          - "â„¹ï¸  SSH Key '{{ key_name }}' å·²å­˜åœ¨"
          - "   å¦‚éœ€é‡æ–°ç”¢ç”Ÿï¼Œè«‹å…ˆåˆªé™¤ç¾æœ‰ Key Pair"
      when: not (is_new_key | bool)
